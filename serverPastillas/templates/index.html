<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Your Website</title>
  <link rel="stylesheet" href="styles.css">
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
<script src="moment.js"></script>
<script src="week_view.js"></script>
<script type="text/javascript">
  $(function () {
    $(".homepage").hide();
    $(".box").delay(500).effect("bounce", { times: 8 }, 800);
    $(".box").hide().slideDown(500);

    $("button").click(function () {
      $(".intro").slideUp(400);
      $(".box").slideUp(200);
      $(".homepage").delay(500).slideDown(300);
    });
  });
  var getUrl = window.location
  const DELTA = 5000;
  var baseUrl = getUrl.protocol + "//" + getUrl.hostname + ":5000"
  var curr_time = 4;
  var time_names = ['noche', 'cena', 'comida', 'desayuno'];
  var week = [['0', '0', '0', '0', '0', '0', '0'],
  ['0', '0', '0', '0', '0', '0', '0'],
  ['0', '0', '0', '0', '0', '0', '0'],
  ['0', '0', '0', '0', '0', '0', '0']];
  const init_view = () => {
    return `
        <div class="intro">
    <div class="black"></div>  
    <div class="white"></div>
    <div class="boxfather">
      <div class="box">
        <h1>WELCOME</h1>
        <button class="start">Enter</button>
      </div>
    </div>
    
  </div>			`
  }
  const form_view = () => {
    return `
	   <h1>${time_names[curr_time - 1]}</h1>
			<form id="time" onsubmit="POST_TIME()" method="post" action="javascript:void(0);" enctype="multipart/form-data">
	   		<input id="schedule" name="schedule" type="time"/>
				<input type="submit" name="subir-datos" value="Submit"/>
			</form>
	`
  }
  const submit_view = (time) => {
    return `
			<div class="container">
			<ul>
				<li>Desayuno : ${time["Desayuno"]}</li>
				<li>Comida : ${time["Comida"]}</li>
				<li>Cena : ${time["Cena"]}</li>
				<li>Noche : ${time["Noche"]}</li>
				</ul>
			<button class="week">Save</button>
			</div>
			`
  }
  const next_dose = (res) => {
    return `
      <div id="space">
  <div class="stars"></div>
  <div class="stars"></div>
  <div class="stars"></div>
  <div class="stars"></div>
  <div class="stars"></div>
</div>
<div class="show_hour">
  <h1>Próxima dosis a las ${res}</h1>
  </div>
      `
  }
  const grab_view = () => {
    return `
      <div class="container">
			<div class="container_center">
        <h1>Dósis lista</h1>
        <span class="arrow arrow-down"></span> 
        </div>
        </div>
      `

  }
  const wait_sch = () => {
    return `
      <div class="container">
			<div class="container_center">
        <h1>No hay dósis programada para hoy ;)</h1>
        <div class="loader loader--style7" title="6">
  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     width="24px" height="30px" viewBox="0 0 24 30" style="enable-background:new 0 0 50 50;" xml:space="preserve">
    <rect x="0" y="0" width="4" height="20" fill="#333">
      <animate attributeName="opacity" attributeType="XML"
        values="1; .2; 1" 
        begin="0s" dur="0.6s" repeatCount="indefinite" />
    </rect>
    <rect x="7" y="0" width="4" height="20" fill="#333">
      <animate attributeName="opacity" attributeType="XML"
        values="1; .2; 1" 
        begin="0.2s" dur="0.6s" repeatCount="indefinite" />
    </rect>
    <rect x="14" y="0" width="4" height="20" fill="#333">
      <animate attributeName="opacity" attributeType="XML"
        values="1; .2; 1" 
        begin="0.4s" dur="0.6s" repeatCount="indefinite" />
    </rect>
  </svg>
    </div>
			</div>
			  </div>
			`
  }
  const ready_dose_view = () =>
  {
    setTimeout(function () { get_next_dose() }, 300000);
    return `
      <div class="container">
			<div class="container_center">
        <h1>Te kiero diego </h1>
        <span class="arrow arrow-down"></span>
			</div>
			  </div>
			`
    
  }
  const GET_API = async (path) => {
    const response = await fetch(baseUrl + path);
    return (response);
  }

  const POST_TIME = async () => {
    const formData = new FormData(document.getElementById("time"));
    console.log(formData.get("schedule"))
    fetch('/time', {
      method: 'POST',
      body: JSON.stringify(formData.get("schedule"))
    })
      .then(function (res) {
        curr_time = curr_time - 1;
        console.log(curr_time);
        if (curr_time > 0)
          document.getElementById("main").innerHTML = form_view();
        else
          submit_controller();
      })
  }

  const POST_WEEK = async () => {
    fetch('/week', {
      method: 'POST',
      body: week
    })
      .then(function (res) {
        console.log(res);
        get_next_dose()
      }
      )
  }
  const add_day = (input) => {
    index = input.id.slice(-3);
    time = parseInt(index.charAt(0), 10) - 1;
    day = parseInt(index.charAt(2), 10) - 1;
    week[time][day] = week[time][day] == '1' ? '0' : '1';
    console.log(week);
  }
  function toArray(list) {
    return Array.prototype.slice.call(list);
  }

  const init_controller = async () => {
    document.getElementById("main").innerHTML = init_view();
  }

  const submit_controller = async () => {
    var time = await GET_API("/time");
    var response = await time.json();
    document.getElementById("main").innerHTML = submit_view(response);
  }

  const table_controller = () => {
    var tbl = document.querySelectorAll("table")[0]
    var table = toArray(tbl.getElementsByTagName("tr"));
    table.forEach(function (row) {
      if (row.id !== "primera") {
        var inputs = toArray(row.getElementsByTagName("input"));
        inputs.forEach(function (input) {
          input.addEventListener("click", function () { add_day(input) })
        })
      }
    })
  }

  const week_controller = () => {
    document.getElementById("main").innerHTML = week_view();
    table_controller();
  }
  const getcho_drugs = () =>
  {
  
      document.getElementById("main").innerHTML = ready_dose_view(); 
  }
  const get_next_dose = async () => {
    var dose = await GET_API("/dose");
    var res = await dose.json();
    console.log(res);
    if (res.message == "NOT TODAY") {
      document.getElementById("main").innerHTML = wait_sch();
    }
    else {
      time_act = res.split(":");
      var then = moment().hour(parseInt(time_act[0])).minute(parseInt(time_act[1]));
      var dif = Math.abs(moment().diff(then));
      setTimeout(function () { getcho_drugs()}, dif + 5000);
      document.getElementById("main").innerHTML = next_dose(res);
    }
  }

  const submit_week_controller = async () => {
    response = await POST_WEEK();
  }

  const form_controller = async () => {
    document.getElementById("main").innerHTML = form_view();
  };

  matchEvent = (ev, sel) => ev.target.matches(sel);
  const myId = (ev) => Number(ev.target.dataset.myId);
  document.addEventListener("click", (ev) => {
    if (matchEvent(ev, ".submit")) submit_controller(myId(ev))
    else if (matchEvent(ev, ".start")) form_controller(myId(ev))
    else if (matchEvent(ev, ".week")) week_controller(myId(ev))
    else if (matchEvent(ev, ".send")) submit_week_controller(myId(ev))

  });
  document.addEventListener("DOMContentLoaded", init_controller);
</script>

<body>
  <div id="main">
  </div>
</body>

</html>